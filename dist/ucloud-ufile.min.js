!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("spark-md5")):"function"==typeof define&&define.amd?define("UCloudUFile",["spark-md5"],t):"object"==typeof exports?exports.UCloudUFile=t(require("spark-md5")):e.UCloudUFile=t(e.SparkMD5)}(window,function(e){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(o,i,function(t){return e[t]}.bind(null,i));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(t,n){t.exports=e},function(e,t,n){"use strict";n.r(t),n.d(t,"UCloudUFile",function(){return r});var o=n(0),i=n.n(o);function a(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var r=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.bucketName=t,this.bucketUrl=n,this.tokenServerUrl=o,this.PREFIX=i,this.uploading=!1,this.contentMd5="",this.slice=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,this.sliceSize=4194304}var t,n,o;return t=e,(n=[{key:"createAjax",value:function(e){var t={};return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(e){var t=Array.prototype.map.call(e,function(e){return 255&e.charCodeAt(0)}),n=new Uint8Array(t);this.send(n.buffer)}),t}},{key:"getBucketUrl",value:function(){var e=this.bucketUrl;return"/"!==e.charAt(e.length-1)&&(e+="/"),e}},{key:"getFileName",value:function(e,t){return t&&""!==t?t:e.name}},{key:"addPrefix",value:function(e){return this.PREFIX?this.PREFIX+"/"+e:e}},{key:"check",value:function(e){if(("[object Object]"!==Object.prototype.toString.call(e)||"[object File]"!==Object.prototype.toString.call(e.file))&&"[object File]"!==Object.prototype.toString.call(e))throw new Error("file参数必须为File数据类型")}},{key:"getContentMd5",value:function(e,t){this.check(e);var n=this,o=new FileReader,a=new i.a.ArrayBuffer,r=Math.ceil(e.size/this.sliceSize),s=0;function l(){var t=s*n.sliceSize,i=t+n.sliceSize>=e.size?e.size:t+n.sliceSize;o.readAsArrayBuffer(n.slice.call(e,t,i))}o.onload=function(e){a.append(e.target.result),++s<r?l():(n.contentMd5=a.end(),t(n.contentMd5))},l()}},{key:"getUFileToken",value:function(e,t,n){var o,i=e.method||"GET",a=e.file||{},r=e.fileName,s=e.md5Required,l=e.contentType||a.type||"",u=e.putPolicy||"";o=r||(a.FileName?a.FileName:a.name?this.addPrefix(a.name):"");var c=this;function d(e,o,i,a,r,s,l,u){var d=c.createAjax(),f=e+"?method="+o+"&bucket="+i+"&key="+a+"&content_md5="+r+"&content_type="+s+"&date="+l+"&put_policy="+u;d.open("GET",f,!0);d.onreadystatechange=function(){4===d.readyState&&(200===d.status?t(d.responseText.trim()):n(d.responseText))},d.send()}"[object File]"===Object.prototype.toString.call(a)&&!1!==s?this.getContentMd5(a,function(e){d(c.tokenServerUrl,i,c.bucketName,encodeURIComponent(o),e,l,"",u)}):d(c.tokenServerUrl,i,c.bucketName,encodeURIComponent(o),"",l,"",u)}},{key:"getFileDetail",value:function(e,t,n){var o=this,i={method:"HEAD",fileName:e};this.getUFileToken(i,function(i){var a=o.createAjax(),r=o.getBucketUrl()+encodeURIComponent(e);a.open("HEAD",r,!0),a.setRequestHeader("Authorization",i);a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status){var e=a.getResponseHeader("ETag"),o={contentType:a.getResponseHeader("Content-Type"),eTag:e.substring(1,e.length-1),status:a.status,response:a.response};t(o)}else n(a.responseText)},a.send()},n)}},{key:"sliceUpload",value:function(e,t,n,o){this.check(e);var i=this,a=e.file||{},r=e.fileRename,s=this.addPrefix(this.getFileName(a,r)),l=new FileReader,u=Math.ceil(a.size/this.sliceSize),c=0;this.initMultipartUpload(function(e){var r=e.Key,s=e.UploadId,d=0,f=0,p="";function h(){var e=c*i.sliceSize,h=e+i.sliceSize>=a.size?a.size:e+i.sliceSize,y=i.slice.call(a,e,h,a.type);y.name=a.name,i.multipartUploading(function(e){f++,p=""===p?e.eTag:p+","+e.eTag,o({status:"uploading",value:f/u}),f===u&&i.multipartUploaded(function(e){t(e)},n,o,r,s,a,p)},n,r,s,d,y),d++,l.readAsArrayBuffer(y)}l.onload=function(e){++c<u&&h()},h()},n,o,a,s)}},{key:"initMultipartUpload",value:function(e,t,n,o,i){var a=this,r=o.type||"",s={method:"POST",file:o,fileName:i,md5Required:!1};this.getUFileToken(s,function(o){var s=a.createAjax(),l=a.getBucketUrl()+encodeURIComponent(i)+"?uploads";s.open("POST",l,!0),s.setRequestHeader("Authorization",o),s.setRequestHeader("Content-Type",r);s.onreadystatechange=function(){4===s.readyState&&(200===s.status?e(JSON.parse(s.response)):t(s.responseText))},s.upload.onprogress=function(e){if(e.lengthComputable){var t={status:"init",value:e.loaded/e.total};n(t)}},s.send()},t)}},{key:"multipartUploading",value:function(e,t,n,o,i,a){var r=this,s={method:"PUT",file:a,fileName:n,md5Required:!1};this.getUFileToken(s,function(s){var l=r.createAjax(),u=r.getBucketUrl()+encodeURIComponent(n)+"?uploadId="+o+"&partNumber="+i;l.open("PUT",u,!0),l.setRequestHeader("Authorization",s),l.setRequestHeader("Content-Type",a.type);l.onreadystatechange=function(){if(4===l.readyState)if(200===l.status){var n=l.getResponseHeader("ETag"),o={eTag:n.substring(1,n.length-1),response:l.response};e(o)}else t(l.responseText)},l.send(a)},t)}},{key:"multipartUploaded",value:function(e,t,n,o,i,a,r){var s=this,l=a.type||"application/octet-stream",u={method:"POST",file:a,fileName:o,md5Required:!1,contentType:l};this.getUFileToken(u,function(a){var u=s.createAjax(),c=s.getBucketUrl()+encodeURIComponent(o)+"?uploadId="+i;u.open("POST",c,!0),u.setRequestHeader("Authorization",a),u.setRequestHeader("Content-Type",l);u.onreadystatechange=function(){4===u.readyState&&(200===u.status?e(u.responseText):t(u.responseText))},u.upload.onprogress=function(e){if(e.lengthComputable){var t={status:"uploaded",value:e.loaded/e.total};n(t)}},u.send(r)},t)}},{key:"hitUpload",value:function(e,t,n,o){this.check(e);var i=this,a=this.addPrefix(this.getFileName(e,o));this.getFileDetail(a,function(o){var r={method:"POST",file:e,fileName:a,md5Required:!1};i.getUFileToken(r,function(r){var s=i.createAjax(),l=i.getBucketUrl()+"uploadhit?Hash="+o.eTag+"&FileName="+encodeURIComponent(a)+"&FileSize="+e.size;s.open("POST",l,!0),s.setRequestHeader("Authorization",r),s.setRequestHeader("Content-Type",e.type);s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.responseText):n(s.responseText))},s.send(e)},n)},n)}},{key:"hitSliceUpload",value:function(e,t,n,o){var i=this,a="",r=e.name.lastIndexOf(".");-1!==r&&(a=e.name.substring(r).substring(1)+"/");var s=e.name.replace(/[\\\/:*?"<>|\r\n\s]/gm,""),l=e.size>1048576?"".concat(parseInt(e.size/1048576),"M"):"".concat(parseInt(e.size/1024),"KB"),u="".concat(parseInt(e.lastModified/1e3),"S-").concat(l,"-").concat(s).substr(0,100),c="".concat(a).concat(u,"/").concat(s);o(),this.hitUpload(e,function(e){console.log("successHit",e),t({Key:i.addPrefix(c)})},function(a){console.log("errorHit",a);var r={file:e,fileRename:c};i.sliceUpload(r,function(e){try{console.log("successSlice",e),t(JSON.parse(e))}catch(e){n()}},function(){console.log("errorSlice"),n()},o)},c)}},{key:"uploadFile",value:function(e,t,n,o){this.check(e);var i=this,a=e.file||{},r=e.fileRename,s=this.addPrefix(this.getFileName(a,r)),l=e.putPolicy,u={method:"PUT",file:a,fileName:s,putPolicy:l};this.getUFileToken(u,function(e){var r=i.createAjax(),l=i.getBucketUrl()+encodeURIComponent(s);r.open("PUT",l,!0),r.setRequestHeader("Authorization",e),r.setRequestHeader("Content-MD5",i.contentMd5),r.setRequestHeader("Content-Type",a.type);r.onreadystatechange=function(){4===r.readyState&&(200===r.status?t({msg:r.responseText,file:a}):n({msg:r.responseText,file:a}))},r.upload.onprogress=function(e){e.lengthComputable&&o(e.loaded/e.total)},r.send(a)},n)}},{key:"batchUpload",value:function(e,t,n,o){var i=this,a=[],r=[],s=0;if(0!=e.length){var l=function(o){r.push(o.file),a.length+r.length==e.length&&(a.length&&t(a),n({errorList:r,successList:a}))},u=function(e){};o(0),i.hitSliceUpload(e[s],function n(r){a.push(r.file),o(a.length/e.length),a.length==e.length?t(a):(s++,i.hitSliceUpload(e[s],n,l,u))},l,u)}else console.warn("批量上传列表为空")}},{key:"formUpload",value:function(e,t,n){this.check(e);var o=this,i=e.file||{},a=e.fileRename,r=this.addPrefix(this.getFileName(i,a)),s=e.putPolicy,l={method:"POST",file:i,fileName:r,putPolicy:s};this.getUFileToken(l,function(e){var a=o.createAjax(),s=o.getBucketUrl(),l=new FileReader;l.addEventListener("load",function(){for(var u=new Uint8Array(l.result),c="",d=0;d<u.length;d++)c+=String.fromCharCode(u[d]);i.binary=c;var f=new Blob([r]),p=new FileReader;p.addEventListener("load",function(){for(var r=new Uint8Array(p.result),l="",u=0;u<r.length;u++)l+=String.fromCharCode(r[u]);var c="----UCloudPOSTFormBoundary",d="--"+c+'\r\nContent-Disposition: form-data; name="FileName"\r\n\r\n'+l+"\r\n--"+c+'\r\nContent-Disposition: form-data; name="Authorization"\r\n\r\n'+e+"\r\n--"+c+'\r\nContent-Disposition: form-data; name="file"; filename="'+l+'"\r\nContent-Type: '+i.type+"\r\n\r\n"+i.binary+"\r\n--"+c+"--\r\n";a.open("POST",s,!0),a.setRequestHeader("Content-MD5",o.contentMd5),a.setRequestHeader("Content-Type","multipart/form-data; boundary="+c);a.onreadystatechange=function(){4==a.readyState&&(200==a.status?t(a.response):n(a.response))},a.sendAsBinary(d)}),f&&p.readAsArrayBuffer(f)}),i&&l.readAsArrayBuffer(i)},n)}},{key:"getFileList",value:function(e,t,n){this.check(e);var o=this,i=e.prefix||o.PREFIX,a=e.marker||"",r=e.limit||20,s={method:"GET"};this.getUFileToken(s,function(e){var s=o.createAjax(),l=o.getBucketUrl()+"?list&prefix="+i+"&marker="+a+"&limit="+r;s.open("GET",l,!0),s.setRequestHeader("Authorization",e);s.onreadystatechange=function(){4==s.readyState&&(200==s.status?t(JSON.parse(s.response)):n(s.responseText))},s.send()},n)}},{key:"deleteFile",value:function(e,t,n){var o=this,i={method:"DELETE",fileName:e};this.getUFileToken(i,function(i){var a=o.createAjax(),r=o.getBucketUrl()+encodeURIComponent(e);a.open("DELETE",r,!0),a.setRequestHeader("Authorization",i);a.onreadystatechange=function(){4==a.readyState&&(204==a.status?t({msg:a.responseText,file:e}):n({msg:a.responseText,file:e}))},a.send()},n)}},{key:"batchDelete",value:function(e,t,n){var o=[],i=[];if(0!=e.length)for(var a=0;a<e.length;a++){this.deleteFile(e[a],function(n){o.push(n.file),o.length==e.length&&t(o)},function(t){i.push(t.file),o.length+i.length==e&&n({successList:o,errorList:i})})}else console.warn("删除列表为空")}},{key:"downloadFile",value:function(e,t,n,o){var i=this,a={method:"GET",fileName:e};this.getUFileToken(a,function(a){var r=i.createAjax(),s=i.getBucketUrl()+encodeURIComponent(e);r.open("GET",s,!0),r.responseType="blob",r.setRequestHeader("Authorization",a);r.onreadystatechange=function(){if(4==r.readyState)if(200==r.status){var o=document.createElement("a"),i=r.response;o.download=e,o.href=URL.createObjectURL(i),o.click(),URL.revokeObjectURL(i),t(r.response)}else n(r.response)},r.onprogress=function(e){e.lengthComputable&&o(e.loaded/e.total)},r.send()},n)}}])&&a(t.prototype,n),o&&a(t,o),e}()}]).UCloudUFile});